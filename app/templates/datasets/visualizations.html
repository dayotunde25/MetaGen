{% extends "base.html" %}

{% block title %}Visualizations - {{ dataset.title }}{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('datasets.list') }}">Datasets</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('datasets.view', dataset_id=dataset.id) }}">{{ dataset.title }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Visualizations</li>
                </ol>
            </nav>
            <h1 class="mb-0">Dataset Visualizations</h1>
            <p class="text-muted">{{ dataset.title }}</p>
        </div>
    </div>

    {% if visualizations and visualizations.charts %}
    <!-- Visualization Summary -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Visualization Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ visualizations.summary.total_charts }}</h3>
                                <p class="mb-0">Total Charts</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success">{{ visualizations.summary.interactive_charts }}</h3>
                                <p class="mb-0">Interactive Charts</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ visualizations.summary.static_images }}</h3>
                                <p class="mb-0">Static Images</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-warning">{{ visualizations.summary.chart_types|length }}</h3>
                                <p class="mb-0">Chart Types</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            Generated on {{ visualizations.generated_at[:10] }} at {{ visualizations.generated_at[11:19] }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="row">
        {% for chart_name, chart_data in visualizations.charts.items() %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ chart_data.title or chart_name|title }}</h6>
                    <span class="badge bg-secondary">{{ chart_data.type|title }}</span>
                </div>
                <div class="card-body">
                    {% if chart_data.type == 'metric' %}
                        <!-- Metric Display -->
                        <div class="text-center py-4">
                            <h2 class="display-4 text-primary mb-2">{{ chart_data.data.value }}</h2>
                            <p class="text-muted">{{ chart_data.data.label or 'Value' }}</p>
                        </div>
                    
                    {% elif chart_data.type == 'gauge' %}
                        <!-- Gauge Chart -->
                        <div class="text-center py-4">
                            <div class="gauge-container position-relative d-inline-block">
                                <svg width="200" height="120" viewBox="0 0 200 120">
                                    <!-- Background arc -->
                                    <path d="M 20 100 A 80 80 0 0 1 180 100" 
                                          stroke="#e9ecef" stroke-width="20" fill="none"/>
                                    <!-- Progress arc -->
                                    <path d="M 20 100 A 80 80 0 0 1 {{ 20 + (160 * chart_data.data.value / chart_data.data.max) }} {{ 100 - (80 * (1 - ((chart_data.data.value / chart_data.data.max - 0.5) * 2) ** 2) ** 0.5) if chart_data.data.value / chart_data.data.max <= 0.5 else 100 - (80 * (1 - ((1 - chart_data.data.value / chart_data.data.max) * 2) ** 2) ** 0.5)) }}" 
                                          stroke="{{ chart_data.data.color }}" stroke-width="20" fill="none"/>
                                    <!-- Value text -->
                                    <text x="100" y="90" text-anchor="middle" class="h4">{{ chart_data.data.label }}</text>
                                </svg>
                            </div>
                        </div>
                    
                    {% elif chart_data.type == 'pie' %}
                        <!-- Pie Chart -->
                        <div class="chart-container">
                            <canvas id="chart-{{ loop.index }}" width="400" height="300"></canvas>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                                new Chart(ctx, {
                                    type: 'pie',
                                    data: {
                                        labels: {{ chart_data.data|map(attribute='name')|list|tojson }},
                                        datasets: [{
                                            data: {{ chart_data.data|map(attribute='value')|list|tojson }},
                                            backgroundColor: {{ chart_data.data|map(attribute='color')|list|tojson }}
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            legend: {
                                                position: 'bottom'
                                            }
                                        }
                                    }
                                });
                            });
                        </script>
                    
                    {% elif chart_data.type == 'bar' %}
                        <!-- Bar Chart -->
                        <div class="chart-container">
                            <canvas id="chart-{{ loop.index }}" width="400" height="300"></canvas>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                                new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: {{ chart_data.data|map(attribute=chart_data.xAxis)|list|tojson }},
                                        datasets: [{
                                            label: '{{ chart_data.yAxis|title }}',
                                            data: {{ chart_data.data|map(attribute=chart_data.yAxis)|list|tojson }},
                                            backgroundColor: {{ chart_data.data|map(attribute='color')|list|tojson if chart_data.data[0].color is defined else ['#3498db'] * chart_data.data|length }}
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                {% if chart_data.max %}max: {{ chart_data.max }}{% endif %}
                                            }
                                        }
                                    }
                                });
                            });
                        </script>
                    
                    {% elif chart_data.type == 'radar' %}
                        <!-- Radar Chart -->
                        <div class="chart-container">
                            <canvas id="chart-{{ loop.index }}" width="400" height="300"></canvas>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                                new Chart(ctx, {
                                    type: 'radar',
                                    data: {
                                        labels: {{ chart_data.data|map(attribute='principle')|list|tojson if chart_data.data[0].principle is defined else chart_data.data|map(attribute='metric')|list|tojson }},
                                        datasets: [{
                                            label: 'Score',
                                            data: {{ chart_data.data|map(attribute='score')|list|tojson }},
                                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                            borderColor: 'rgba(52, 152, 219, 1)',
                                            pointBackgroundColor: 'rgba(52, 152, 219, 1)'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        scales: {
                                            r: {
                                                beginAtZero: true,
                                                max: {{ chart_data.max or 100 }}
                                            }
                                        }
                                    }
                                });
                            });
                        </script>
                    
                    {% elif chart_data.type == 'table' %}
                        <!-- Data Table -->
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        {% for column in chart_data.columns %}
                                        <th>{{ column|title }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in chart_data.data %}
                                    <tr>
                                        {% for column in chart_data.columns %}
                                        <td>{{ row[column] }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    
                    {% elif chart_data.type == 'image' %}
                        <!-- Static Image -->
                        <div class="text-center">
                            <img src="{{ chart_data.data.image }}" 
                                 alt="{{ chart_data.title }}" 
                                 class="img-fluid rounded shadow-sm"
                                 style="max-height: 400px;">
                        </div>
                    
                    {% else %}
                        <!-- Fallback: JSON Display -->
                        <div class="bg-light p-3 rounded">
                            <small class="text-muted">Raw Data:</small>
                            <pre class="mt-2 mb-0"><code>{{ chart_data.data|tojson(indent=2) }}</code></pre>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Export Options -->
    <div class="row mt-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-download me-2"></i>
                        Export Options
                    </h6>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('datasets.api_visualizations', dataset_id=dataset.id) }}" 
                           class="btn btn-outline-primary" target="_blank">
                            <i class="fas fa-code me-2"></i>
                            JSON Data
                        </a>
                        <button type="button" class="btn btn-outline-success" onclick="printCharts()">
                            <i class="fas fa-print me-2"></i>
                            Print Charts
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="shareVisualization()">
                            <i class="fas fa-share me-2"></i>
                            Share Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Visualizations Available -->
    <div class="row">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                    <h4>No Visualizations Available</h4>
                    <p class="text-muted mb-4">
                        Visualizations will be generated automatically when the dataset is processed.
                    </p>
                    <a href="{{ url_for('datasets.view', dataset_id=dataset.id) }}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to Dataset
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin: 10px 0;
    }
    
    .gauge-container svg {
        max-width: 100%;
        height: auto;
    }
    
    @media print {
        .card {
            break-inside: avoid;
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: none;
        }
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function printCharts() {
        window.print();
    }
    
    function shareVisualization() {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: 'Dataset Visualizations - {{ dataset.title }}',
                url: url
            });
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }
    }
</script>
{% endblock %}
