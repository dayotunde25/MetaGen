{% extends "base.html" %}

{% block title %}{{ dataset.title }} - Dataset Metadata Manager{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('datasets.list_datasets') }}">Datasets</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ dataset.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main dataset info -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 class="mb-0">{{ dataset.title }}</h1>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('datasets.edit_dataset', dataset_id=dataset.id) }}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-1"></i> Edit
                            </a>
                            {% if dataset.status == 'pending' %}
                            <a href="{{ url_for('datasets.process_dataset', dataset_id=dataset.id) }}" class="btn btn-outline-success">
                                <i class="fas fa-play me-1"></i> Process
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">Description</h5>
                        <p>{{ dataset.description or 'No description provided.' }}</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="mb-3">Source Information</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 30%">Source:</th>
                                    <td>{{ dataset.source or 'Not specified' }}</td>
                                </tr>
                                <tr>
                                    <th>Source URL:</th>
                                    <td>
                                        {% if dataset.source_url %}
                                        <a href="{{ dataset.source_url }}" target="_blank">{{ dataset.source_url }} <i class="fas fa-external-link-alt fa-sm"></i></a>
                                        {% else %}
                                        Not specified
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Added on:</th>
                                    <td>{{ dataset.created_at.strftime('%B %d, %Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Last updated:</th>
                                    <td>{{ dataset.updated_at.strftime('%B %d, %Y') }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">Dataset Properties</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th style="width: 30%">Category:</th>
                                    <td>
                                        {% if dataset.category %}
                                        <span class="badge bg-secondary">{{ dataset.category }}</span>
                                        {% else %}
                                        Not specified
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Data Type:</th>
                                    <td>
                                        {% if dataset.data_type %}
                                        <span class="badge bg-info">{{ dataset.data_type }}</span>
                                        {% else %}
                                        Not specified
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Format:</th>
                                    <td>{{ dataset.format or 'Unknown' }}</td>
                                </tr>
                                <tr>
                                    <th>Size:</th>
                                    <td>{{ dataset.size or 'Unknown' }}</td>
                                </tr>
                                <tr>
                                    <th>Records:</th>
                                    <td>{{ dataset.record_count or 'Unknown' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="mb-3">Tags</h5>
                        <div>
                            {% if dataset.tags %}
                                {% for tag in dataset.tags_list() %}
                                <span class="badge bg-primary mb-1">{{ tag }}</span>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No tags available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing history -->
            {% if dataset.processing %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Processing History</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{% if dataset.status == 'completed' %}success{% elif dataset.status == 'processing' %}warning{% elif dataset.status == 'pending' %}info{% elif dataset.status == 'failed' %}danger{% else %}secondary{% endif %}">
                                {{ dataset.status.title() }}
                            </span>
                        </p>
                        
                        {% if dataset.processing.progress is not none %}
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar {% if dataset.status == 'processing' %}progress-bar-striped progress-bar-animated{% endif %}" 
                                role="progressbar" 
                                style="width: {{ dataset.processing.progress }}%">
                                {{ dataset.processing.progress }}%
                            </div>
                        </div>
                        {% endif %}
                        
                        <p><strong>Added to queue:</strong> {{ dataset.processing.created_at.strftime('%B %d, %Y %H:%M') }}</p>
                        
                        {% if dataset.processing.started_at %}
                        <p><strong>Processing started:</strong> {{ dataset.processing.started_at.strftime('%B %d, %Y %H:%M') }}</p>
                        {% endif %}
                        
                        {% if dataset.processing.completed_at %}
                        <p><strong>Processing completed:</strong> {{ dataset.processing.completed_at.strftime('%B %d, %Y %H:%M') }}</p>
                        {% endif %}
                        
                        {% if dataset.processing.error_message %}
                        <div class="alert alert-danger mt-3">
                            <h6 class="alert-heading">Processing Error</h6>
                            <p class="mb-0">{{ dataset.processing.error_message }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Metadata quality sidebar -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Quality Assessment</h5>
                </div>
                <div class="card-body">
                    {% if dataset.metadata %}
                    <div class="text-center mb-4">
                        <div class="quality-score {{ 'quality-high' if dataset.metadata.quality_score >= 80 else ('quality-medium' if dataset.metadata.quality_score >= 50 else 'quality-low') }}">
                            {{ dataset.metadata.quality_score|int }}
                        </div>
                        <p class="mt-2 mb-0">Overall Quality Score</p>
                    </div>

                    <div class="mb-4">
                        <h6>FAIR Compliance</h6>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="fair-indicator fair-f"></i> Findable</span>
                                <span>{{ dataset.metadata.findable_score|int }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success fair-score" role="progressbar" 
                                     style="width: {{ dataset.metadata.findable_score }}%" 
                                     data-score="{{ dataset.metadata.findable_score }}" 
                                     data-category="Findable"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="fair-indicator fair-a"></i> Accessible</span>
                                <span>{{ dataset.metadata.accessible_score|int }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary fair-score" role="progressbar" 
                                     style="width: {{ dataset.metadata.accessible_score }}%" 
                                     data-score="{{ dataset.metadata.accessible_score }}" 
                                     data-category="Accessible"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="fair-indicator fair-i"></i> Interoperable</span>
                                <span>{{ dataset.metadata.interoperable_score|int }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning fair-score" role="progressbar" 
                                     style="width: {{ dataset.metadata.interoperable_score }}%" 
                                     data-score="{{ dataset.metadata.interoperable_score }}" 
                                     data-category="Interoperable"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span><i class="fair-indicator fair-r"></i> Reusable</span>
                                <span>{{ dataset.metadata.reusable_score|int }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-purple fair-score" role="progressbar" 
                                     style="width: {{ dataset.metadata.reusable_score }}%" 
                                     data-score="{{ dataset.metadata.reusable_score }}" 
                                     data-category="Reusable"></div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="{{ url_for('datasets.dataset_metadata', dataset_id=dataset.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-code me-1"></i> View Full Metadata
                        </a>
                    </div>
                    
                    {% if dataset.metadata.recommendations_list() %}
                    <div class="mt-4">
                        <h6>Improvement Recommendations</h6>
                        <ul class="list-group list-group-flush">
                            {% for rec in dataset.metadata.recommendations_list() %}
                            <li class="list-group-item px-0">
                                <i class="fas fa-lightbulb text-warning me-2"></i> {{ rec }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-chart-pie fa-3x text-muted"></i>
                        </div>
                        <h5>No quality assessment</h5>
                        <p class="text-muted">Process this dataset to generate quality metrics</p>
                        {% if dataset.status == 'pending' %}
                        <a href="{{ url_for('datasets.process_dataset', dataset_id=dataset.id) }}" class="btn btn-primary mt-2">
                            <i class="fas fa-play me-1"></i> Process Dataset
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}